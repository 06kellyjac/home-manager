#!@bash@/bin/bash

function doBuild() {
    if [[ -z "$1" ]]; then
        echo "Need to provide path to configuration file."
        exit 1
    fi

    if [[ -z "$2" ]]; then
        echo "Need to provide generation output path."
        exit 1
    fi

    if [[ -e "$2" ]]; then
        echo "The output path $2 already exists."
        exit 1
    fi

    local confFile output
    confFile="$(realpath "$1")"
    output="$(realpath "$2")"

    nix-build --show-trace \
              "@HOME_MANAGER_EXPR_PATH@" \
              --argstr modulesPath "@MODULES_PATH@" \
              --argstr confPath "$confFile" \
              -A activation-script \
              -o "$output"
}

function doSwitch() {
    local wrkdir
    wrkdir="$(mktemp -d)"

    if doBuild "$1" "$wrkdir/generation" ; then
        "$wrkdir/generation/activate"
    fi

    rm -r "$wrkdir"
}

function doListGens() {
    pushd "/nix/var/nix/profiles/per-user/$USER" > /dev/null
    ls --color=yes -gG --sort time home-manager-*-link \
        | cut -d' ' -f 4-
    popd > /dev/null
}

function doListPackages() {
    local outPath
    outPath="$(nix-env -q --out-path | grep -o '/.*home-manager-path$')"
    if [[ -n "$outPath" ]] ; then
        nix-store -q --references "$outPath" | sed 's/[^-]*-//'
    else
        echo "No home-manager packages seem to be installed."
    fi
}

function doHelp() {
    echo "Usage: $0 COMMAND"
    echo
    echo "Commands"
    echo "  help         Print this help"
    echo "  build CONF   Build configuration into result directory"
    echo "  switch CONF  Build and activate configuration"
    echo "  generations  List all home environment generations"
    echo "  packages     List all packages installed in home-manager-path"
}

case "$1" in
    build)
        doBuild "$2" "result"
        ;;
    switch)
        doSwitch "$2"
        ;;
    generations)
        doListGens
        ;;
    packages)
        doListPackages
        ;;
    help|--help)
        doHelp
        ;;
    *)
        echo "Unknown command: $1"
        doHelp
        exit 1
        ;;
esac
